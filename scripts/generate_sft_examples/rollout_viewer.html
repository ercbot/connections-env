<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connections Rollout Viewer</title>
    <link rel="stylesheet" href="rollout_viewer.css">
</head>
<body>
    <div class="header">
        <div>
            <h1>Connections Rollout Viewer</h1>
        </div>
        <button class="save-button" id="saveButton" onclick="saveExamples()" title="Save all examples to JSONL (Cmd+S / Ctrl+S)">üíæ Save</button>
    </div>

    <div class="controls">
        <div>
            <label for="typeFilter">Type:</label>
            <select id="typeFilter">
                <option value="all">All</option>
                <option value="good">Good Examples</option>
                <option value="doctored">Doctored Examples</option>
            </select>
        </div>

        <div>
            <label for="completeFilter">Complete Reason:</label>
            <select id="completeFilter">
                <option value="all">All</option>
            </select>
        </div>

        <div>
            <label for="searchPuzzle">Search Puzzle ID:</label>
            <input type="text" id="searchPuzzle" placeholder="Enter puzzle ID">
        </div>

        <button onclick="applyFilters()">Apply Filters</button>

        <div class="navigation">
            <button onclick="prevExample()" id="prevBtn">‚Üê Previous</button>
            <span id="exampleCounter">-</span>
            <button onclick="nextExample()" id="nextBtn">Next ‚Üí</button>
            <button onclick="randomExample()">üé≤ Random</button>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="no-data loading-screen" id="loadingScreen">
            <div class="no-data-icon">üìÇ</div>
            <h2>Load a JSONL file</h2>
            <p style="margin-top: 10px;">
                <input type="file" id="fileInput" accept=".jsonl" onchange="loadFile(event)" style="margin-top: 20px;">
            </p>
            <p style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                Load a rollout results file (e.g. results.jsonl) or open via the validation server
            </p>
        </div>
    </div>

    <script>
        let allExamples = [];
        let filteredExamples = [];
        let currentIndex = 0;
        let showSystemMessages = false;
        let viewMode = 'conversation';

        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                allExamples = lines.map(line => JSON.parse(line));

                initializeViewer();
            };
            reader.readAsText(file);
        }

        function initializeWithData(examples) {
            allExamples = examples;
            document.getElementById('loadingScreen').style.display = 'none';
            initializeViewer();
        }

        function initializeViewer() {
            const completeFilter = document.getElementById('completeFilter');
            [...new Set(allExamples.map(e => e.complete_reason || 'unknown'))].sort().forEach(reason => {
                const option = document.createElement('option');
                option.value = option.textContent = reason;
                completeFilter.appendChild(option);
            });
            applyFilters();
        }

        function applyFilters() {
            const typeFilter = document.getElementById('typeFilter').value;
            const completeFilter = document.getElementById('completeFilter').value;
            const searchPuzzle = document.getElementById('searchPuzzle').value.trim().toLowerCase();

            filteredExamples = allExamples.filter(example => {
                const typeMatch = typeFilter === 'all' ||
                    (typeFilter === 'good' && !example.doctored) ||
                    (typeFilter === 'doctored' && example.doctored);

                const completeMatch = completeFilter === 'all' ||
                    (example.complete_reason || 'unknown') === completeFilter;

                const puzzleId = example.puzzle_id || example.info?.puzzle_id || '';
                const puzzleMatch = !searchPuzzle || puzzleId.toString().toLowerCase().includes(searchPuzzle);

                return typeMatch && completeMatch && puzzleMatch;
            });

            currentIndex = 0;
            updateStats();
            renderExample();
        }

        function updateStats() {
            const exampleCounter = document.getElementById('exampleCounter');
            if (filteredExamples.length > 0) {
                exampleCounter.textContent = `${currentIndex + 1} / ${filteredExamples.length}`;
            } else {
                exampleCounter.textContent = '-';
            }

            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex >= filteredExamples.length - 1;
        }

        function saveExamples() {
            if (allExamples.length === 0) {
                alert('No examples to save');
                return;
            }

            // Convert all examples to JSONL format
            const jsonlContent = allExamples.map(example => JSON.stringify(example)).join('\n');
            
            // Create a blob and download it
            const blob = new Blob([jsonlContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'examples.jsonl';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Show feedback
            const saveButton = document.getElementById('saveButton');
            const originalText = saveButton.textContent;
            saveButton.textContent = '‚úì Saved!';
            saveButton.style.background = '#10b981';
            setTimeout(() => {
                saveButton.textContent = originalText;
                saveButton.style.background = '';
            }, 2000);
        }

        function prevExample() {
            if (currentIndex > 0) {
                currentIndex--;
                renderExample();
            }
        }

        function nextExample() {
            if (currentIndex < filteredExamples.length - 1) {
                currentIndex++;
                renderExample();
            }
        }

        function randomExample() {
            if (filteredExamples.length > 0) {
                currentIndex = Math.floor(Math.random() * filteredExamples.length);
                renderExample();
            }
        }

        function getFoundCategoryIndices(example) {
            const foundIndices = new Set();
            (example.guess_history || []).forEach(guess => {
                if ((guess.status === 'correct' || guess.status === 'auto') && guess.category_idx != null) {
                    foundIndices.add(parseInt(guess.category_idx));
                }
            });
            return foundIndices;
        }

        function getAllCategories(example) {
            const allCategories = example.categories || example.info?.categories || [];
            const foundIndices = getFoundCategoryIndices(example);
            return allCategories.map((cat, idx) => ({ ...cat, isFound: foundIndices.has(idx) }))
                .sort((a, b) => a.isFound === b.isFound ? 0 : a.isFound ? -1 : 1);
        }

        function renderExample() {
            updateStats();

            if (filteredExamples.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="no-data no-results">
                        <div class="no-data-icon">üîç</div>
                        <h2>No examples match your filters</h2>
                        <p style="margin-top: 10px;">Try adjusting the filters above</p>
                    </div>
                `;
                return;
            }

            const example = filteredExamples[currentIndex];
            const categories = getAllCategories(example);
            const puzzleId = example.puzzle_id || example.info?.puzzle_id || 'unknown';
            const reward = example.reward || 0;
            const accuracy = example.accuracy || 0;
            const completeReason = example.complete_reason || 'unknown';
            const isDoctored = example.doctored || false;
            const foundCount = getFoundCategoryIndices(example).size;
            const totalCategories = categories.length;

            const fullConversation = [...(example.prompt || []), ...(example.completion || [])];

            const html = `
                <div class="left-panel">
                    <div class="example-info ${isDoctored ? 'doctored' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="badge ${isDoctored ? 'doctored' : 'good'}">
                                ${isDoctored ? 'Doctored' : 'Good'}
                            </span>
                        </div>
                        <div class="example-info-grid">
                            <div class="info-item">
                                <span class="info-label">Puzzle ID</span>
                                <span class="info-value">${puzzleId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Reward</span>
                                <span class="info-value">${reward.toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Accuracy</span>
                                <span class="info-value">${(accuracy * 100).toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Complete Reason</span>
                                <span class="info-value">${completeReason}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Categories Found</span>
                                <span class="info-value">${foundCount}${totalCategories > 0 ? ` / ${totalCategories}` : ''}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Total Messages</span>
                                <span class="info-value">${fullConversation.length}</span>
                            </div>
                        </div>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-dot found"></div>
                                <span>Found</span>
                            </div>
                        </div>
                    </div>
                    <div class="categories-section">
                        <h2 class="section-title">üéØ Categories</h2>
                        ${categories.length > 0 ? renderCategories(categories) : '<p style="color: #6b7280; font-size: 14px;">Categories not available in synthesized format</p>'}
                    </div>
                </div>
                <div class="right-panel">
                    <div class="conversation-section">
                        <h2 class="section-title">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>View</span>
                                <select id="viewModeSelect" onchange="changeViewMode()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 600;">
                                    <option value="conversation" ${viewMode === 'conversation' ? 'selected' : ''}>Full Conversation</option>
                                    <option value="guesses" ${viewMode === 'guesses' ? 'selected' : ''}>Guess History</option>
                                </select>
                            </div>
                            <div class="section-title-controls">
                                <label class="toggle-switch" id="systemToggleContainer">
                                    <input type="checkbox" id="showSystemToggle" onchange="toggleSystemMessages()" ${showSystemMessages ? 'checked' : ''}>
                                    <span>Show System Message</span>
                                </label>
                            </div>
                        </h2>
                        <div id="conversationMessages">
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            updateViewContent();
        }

        function renderCategories(categories) {
            return categories.map(cat => {
                const statusClass = cat.isFound ? 'found' : '';
                const statusIcon = cat.isFound ? '‚úì' : '‚óã';
                return `
                    <div class="category ${statusClass}">
                        <div class="category-header">
                            <span class="category-status">${statusIcon}</span>
                            <div class="category-theme">${escapeHtml(cat.group || 'Unknown')}</div>
                        </div>
                        <div class="category-words">${cat.members.map(m => `\`${m}\``).join(', ')}</div>
                    </div>
                `;
            }).join('');
        }

        let currentMessagesForCopy = [];

        function renderMessages(messages, showSystem = false) {
            const filteredMessages = showSystem ? messages : messages.filter(msg => msg.role !== 'system');
            currentMessagesForCopy = filteredMessages;
            // Store mapping from filtered index to full conversation index
            const indexMap = [];
            messages.forEach((msg, idx) => {
                if (showSystem || msg.role !== 'system') {
                    indexMap.push(idx);
                }
            });
            
            return filteredMessages.map((msg, index) => {
                const roleClass = msg.role;
                const content = highlightTags(escapeHtml(msg.content));
                const isAssistant = msg.role === 'assistant';
                const isUser = msg.role === 'user';
                const editButton = isAssistant ? `<button class="edit-button" onclick="editMessage(${index})" title="Edit message">‚úèÔ∏è Edit</button>` : '';
                const clipButton = isUser ? `<button class="clip-button" onclick="clipMessages(${indexMap[index]})" title="Remove all messages after this">‚úÇÔ∏è Clip</button>` : '';
                return `
                    <div class="message ${roleClass}" data-message-index="${index}">
                        <div class="message-header">
                            <div class="message-role">${msg.role}</div>
                            <div class="message-header-buttons">
                                ${clipButton}
                                ${editButton}
                                <button class="copy-button" onclick="copyMessageText(${index})" title="Copy raw text">üìã Copy</button>
                            </div>
                        </div>
                        <div class="message-content" data-original-content="${escapeHtml(msg.content)}">${content}</div>
                    </div>
                `;
            }).join('');
        }

        function copyMessageText(index) {
            if (index < 0 || index >= currentMessagesForCopy.length) return;
            const text = currentMessagesForCopy[index].content || '';
            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(text).then(() => showCopyFeedback(index)).catch(() => copyWithExecCommand(text, index));
            } else {
                copyWithExecCommand(text, index);
            }
        }

        function copyWithExecCommand(text, index) {
            const textarea = document.createElement('textarea');
            Object.assign(textarea.style, { position: 'fixed', opacity: '0' });
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); showCopyFeedback(index); } catch (e) {}
            document.body.removeChild(textarea);
        }

        function showCopyFeedback(index) {
            const messageElement = document.querySelector(`[data-message-index="${index}"]`);
            if (!messageElement) return;
            
            const button = messageElement.querySelector('.copy-button');
            if (!button) return;
            
            const originalText = button.textContent;
            button.textContent = '‚úì Copied!';
            button.style.color = '#10b981';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.color = '';
            }, 2000);
        }

        function clipMessages(fullIndex) {
            const example = filteredExamples[currentIndex];
            const fullConversation = [...(example.prompt || []), ...(example.completion || [])];
            
            if (fullIndex < 0 || fullIndex >= fullConversation.length) return;
            
            // Determine if the message is in prompt or completion
            const promptLength = (example.prompt || []).length;
            
            if (fullIndex < promptLength) {
                // Message is in prompt, clip from prompt
                example.prompt = (example.prompt || []).slice(0, fullIndex + 1);
                // Remove all completion messages
                example.completion = [];
                // Remove all guesses (guesses happen in completion)
                example.guess_history = [];
            } else {
                // Message is in completion, clip from completion
                const completionIndex = fullIndex - promptLength;
                example.completion = (example.completion || []).slice(0, completionIndex + 1);
                
                // Clip guess_history to match the number of assistant messages in the clipped completion
                // Each guess corresponds to an assistant message
                const clippedCompletion = example.completion;
                let assistantCount = 0;
                for (const msg of clippedCompletion) {
                    if (msg.role === 'assistant') {
                        assistantCount++;
                    }
                }
                // Clip guess_history to match the number of assistant messages
                example.guess_history = (example.guess_history || []).slice(0, assistantCount);
            }
            
            // Re-render the view
            updateViewContent();
        }

        function editMessage(index) {
            if (index < 0 || index >= currentMessagesForCopy.length) return;
            const messageElement = document.querySelector(`[data-message-index="${index}"]`);
            if (!messageElement) return;
            
            const contentElement = messageElement.querySelector('.message-content');
            if (!contentElement) return;
            
            const isEditing = contentElement.classList.contains('editable');
            
            if (isEditing) {
                // Save changes
                const newContent = contentElement.textContent || contentElement.innerText || '';
                currentMessagesForCopy[index].content = newContent;
                contentElement.classList.remove('editable');
                contentElement.contentEditable = 'false';
                contentElement.innerHTML = highlightTags(escapeHtml(newContent));
                contentElement.setAttribute('data-original-content', escapeHtml(newContent));
                
                // Update button
                const editButton = messageElement.querySelector('.edit-button');
                if (editButton) {
                    editButton.textContent = '‚úèÔ∏è Edit';
                    editButton.onclick = () => editMessage(index);
                }
            } else {
                // Start editing
                const originalContent = contentElement.getAttribute('data-original-content') || currentMessagesForCopy[index].content || '';
                contentElement.classList.add('editable');
                contentElement.contentEditable = 'true';
                contentElement.textContent = originalContent;
                contentElement.focus();
                
                // Update button
                const editButton = messageElement.querySelector('.edit-button');
                if (editButton) {
                    editButton.textContent = 'üíæ Save';
                    editButton.onclick = () => editMessage(index);
                }
            }
        }

        function toggleSystemMessages() {
            showSystemMessages = document.getElementById('showSystemToggle').checked;
            updateViewContent();
        }

        function changeViewMode() {
            viewMode = document.getElementById('viewModeSelect').value;
            updateViewContent();
        }

        function updateViewContent() {
            const example = filteredExamples[currentIndex];
            const container = document.getElementById('conversationMessages');
            const systemToggle = document.getElementById('systemToggleContainer');
            
            if (viewMode === 'conversation') {
                systemToggle.style.display = 'flex';
                const fullConversation = [...(example.prompt || []), ...(example.completion || [])];
                container.innerHTML = renderMessages(fullConversation, showSystemMessages);
            } else {
                systemToggle.style.display = 'none';
                container.innerHTML = renderGuessHistory(example.guess_history || []);
            }
        }

        function renderGuessHistory(guessHistory) {
            if (guessHistory.length === 0) {
                return '<p style="color: #6b7280; font-size: 14px; padding: 15px;">No guesses recorded</p>';
            }
            return guessHistory.map((guess, index) => {
                const isCorrect = guess.status === 'correct' || guess.status === 'auto';
                const statusColor = isCorrect ? '#10b981' : '#ef4444';
                return `
                    <div class="guess-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="guess-header">
                            <div class="guess-label" style="color: ${statusColor};">Guess ${index + 1} ${isCorrect ? '‚úì' : '‚úó'}</div>
                            <div class="guess-status" style="color: ${statusColor};">${guess.status.toUpperCase()}</div>
                        </div>
                        <div class="guess-words">
                            ${(guess.items || guess.words || []).map(w => `<code class="guess-word">${escapeHtml(w)}</code>`).join('')}
                        </div>
                        ${guess.category_idx != null ? `<div class="guess-category">Category: ${guess.category_idx}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function highlightTags(text) {
            const tags = [
                [/&lt;think&gt;/g, '<think>&lt;think&gt;'],
                [/&lt;\/think&gt;/g, '&lt;/think&gt;</think>'],
                [/&lt;redacted_reasoning&gt;/g, '<think>&lt;redacted_reasoning&gt;'],
                [/&lt;\/redacted_reasoning&gt;/g, '&lt;/redacted_reasoning&gt;</think>'],
                [/&lt;guess&gt;/g, '<guess>&lt;guess&gt;'],
                [/&lt;\/guess&gt;/g, '&lt;/guess&gt;</guess>']
            ];
            return tags.reduce((t, [pattern, replacement]) => t.replace(pattern, replacement), text);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevExample();
            else if (e.key === 'ArrowRight') nextExample();
            else if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                saveExamples();
            }
        });
    </script>
</body>
</html>

